---
name: "Prune pull requests image tags from GitHub Packages"
description: "Action to prune existing package versions related to closed pull requests"
author: hoverkraft
branding:
  icon: delete
  color: blue

outputs:
  deleted-image-tags:
    description: |
      The list of deleted tags for given image.
      Example:
      ```json
      ["1.0.0", "1.0.1"]
      ```
    value: ${{ steps.clean-images.outputs.deleted-package-versions }}

inputs:
  image:
    description: "Image name"
    required: false
  pull-request-tag-filter:
    description: "The regular expression to match pull request tags. Must have a capture group for the pull request number."
    default: "^pr-([0-9]+)(?:-|$)"
  preserve-tags-filter:
    description: |
      Optional regular expression to match tags that should be preserved (not deleted).
      Tags matching this pattern will never be deleted, even if they are on a package version with PR tags.
      Example: "^v.*" to preserve version tags like v1.0.0, v2.1.3, etc.
    required: false
    default: ""
  github-token:
    description: |
      GitHub token with the folowing scopes: `pull-requests:read`, `packages:read` and `packages:delete`.
      See https://docs.github.com/en/packages/learn-github-packages/about-permissions-for-github-packages#about-scopes-and-permissions-for-package-registries.
    default: ${{ github.token }}

runs:
  using: "composite"
  steps:
    - shell: bash
      # FIXME: workaround until will be merged: https://github.com/actions/runner/pull/1684
      run: mkdir -p ./self-actions/ && cp -r $GITHUB_ACTION_PATH/../../* ./self-actions/

    - id: image-name
      uses: ./self-actions/docker/get-image-name
      with:
        image: ${{ inputs.image }}

    - id: is-organization-or-user
      uses: hoverkraft-tech/ci-github-common/actions/repository-owner-is-organization@b17226e57c8ef31f860719766656ebb6df017218 # 0.31.6

    - id: get-tags-to-delete
      uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
      env:
        PULL_REQUEST_TAG_FILTER: ${{ inputs.pull-request-tag-filter }}
        PRESERVE_TAGS_FILTER: ${{ inputs.preserve-tags-filter }}
        IMAGE_NAME: ${{ steps.image-name.outputs.image-name }}
        IS_ORGANIZATION: ${{ steps.is-organization-or-user.outputs.is-organization }}
      with:
        github-token: ${{ inputs.github-token }}
        script: |
          const pullRequestTagFilter = process.env.PULL_REQUEST_TAG_FILTER;
          if (!pullRequestTagFilter.length) {
              return core.setFailed('Input "pull-request-tag-filter" is undefined');
          }

          // Assert that the regex has a valid capture group for the pull request number
          const hasCaptureGroupMatch = pullRequestTagFilter.match(/\([^?]([^)]+)\)/g);
          if (!hasCaptureGroupMatch) {
            return core.setFailed(
              `Input "pull-request-tag-filter" ${pullRequestTagFilter} must have a capture group for the pull request number`
            );
          }

          if (hasCaptureGroupMatch.length !== 1) {
            return core.setFailed(
              `Input "pull-request-tag-filter" ${pullRequestTagFilter} must have only one capture group for the pull request number`
            );
          }

          const imageName = process.env.IMAGE_NAME;
          const isOrganization = process.env.IS_ORGANIZATION === 'true';
          const preserveTagsFilter = process.env.PRESERVE_TAGS_FILTER;

          const script = require(`${{ github.action_path }}/index.js`)
          const tagsToDelete = await script({
            github,
            context,
            core,
            imageName,
            pullRequestTagFilter,
            preserveTagsFilter,
            isOrganization,
          });

          // Convert tags to comma-separated string for delete-tags input
          if (tagsToDelete.length === 0) {
            core.info('No tags to delete');
            return;
          }

          const tagsString = tagsToDelete.join(',');
          core.setOutput('tags-to-delete', tagsString);
          core.info(`Tags to delete: ${tagsString}`);

    - id: clean-images
      uses: ./self-actions/docker/clean-images
      if: steps.get-tags-to-delete.outputs.tags-to-delete
      with:
        github-token: ${{ inputs.github-token }}
        package: ${{ steps.image-name.outputs.image-name }}
        tags: ${{ steps.get-tags-to-delete.outputs.tags-to-delete }}

    - shell: bash
      # FIXME: workaround until will be merged: https://github.com/actions/runner/pull/1684
      run: |
        rm -fr ./self-actions
