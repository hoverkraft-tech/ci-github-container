<!-- start branding -->
<!-- end branding -->
<!-- start title -->

# GitHub Reusable Workflow: Docker build images

<!-- end title -->
<!-- start badges -->
<!-- end badges -->
<!-- start description -->

Workflow to build multiple docker images.
Build images using [Docker build-image action](../../actions/docker/build-image/README.md)
This includes [multi-platform](https://docs.docker.com/build/building/multi-platform/) build

Needs the following permissions:

- `contents`: `read`
- `issues`: `read`
- `packages`: `write`
- `pull-requests`: `read`
- `id-token`: `write`

<!-- end description -->
<!-- start contents -->
<!-- end contents -->
<!-- start usage -->

```yaml
name: Docker build images

on:
  merge_group:
  pull_request:
    branches: [main]

permissions:
  contents: read
  issues: read
  packages: write
  pull-requests: read
  id-token: write

jobs:
  docker-build-images:
    uses: hoverkraft-tech/ci-github-container/.github/workflows/docker-build-images.yml@0.26.0
    secrets:
      # Password or GitHub token (packages:read and packages:write scopes) used to log against the OCI registry.
      # See https://github.com/docker/login-action#usage.
      oci-registry-password: ${{ secrets.GITHUB_TOKEN }}

      # List of secrets to expose to the build.
      # See <https://docs.docker.com/build/ci/github-actions/secrets/>.
      build-secrets: ""

      # GitHub App private key to generate GitHub token to be passed as build secret env.
      # See <https://github.com/actions/create-github-app-token>.
      build-secret-github-app-key: ""

    # Optional customizations.
    with:
      # Json array of runner(s) to use.
      # See https://docs.github.com/en/actions/using-jobs/choosing-the-runner-for-a-job
      # Default: '["ubuntu-latest"]'
      runs-on: '["ubuntu-latest"]'

      # OCI registry where to pull and push images.
      oci-registry: ""

      # Username used to log against the OCI registry. See https://github.com/docker/login-action#usage
      # Default: "${{ github.repository_owner }}"
      oci-registry-username: ""

      #  Images to build parameters. Json array of objects.
      #  Example: [
      #    {
      #      "name": "application",
      #      "context": ".",
      #      "dockerfile": "./docker/application/Dockerfile",
      #      "target": "prod",
      #      "build-args": {
      #        "APP_PATH": "./application/",
      #        "PROD_MODE": "true"
      #      },
      #      "secret-envs": {
      #        "GH_TOKEN": "GITHUB_TOKEN"
      #      },
      #      "platforms": [
      #        "linux/amd64",
      #        {
      #          "name": "darwin/amd64",
      #          "runs-on": "macos-latest"
      #        }
      #      ]
      #    }
      #  ]
      images: ""

      # Enable Git LFS.
      # See <https://github.com/actions/checkout?tab=readme-ov-file#usage>.
      # Default: true
      lfs: true

      # Environment variable name(s) to pass GitHub token generated by GitHub App.
      # Can be a multiline string list.
      # This is useful to pass a generated token to the build, as it is not possible to share generated secrets between jobs.
      # Needs input `build-secret-github-app-id` and secret `build-secret-github-app-key`.
      # Default: "GITHUB_APP_TOKEN"
      build-secret-github-app-token-env: |
        GITHUB_APP_TOKEN

      # GitHub App ID to generate GitHub token to be passed as build secret env.
      # See <https://github.com/actions/create-github-app-token>.
      build-secret-github-app-id: ""

      # The owner of the GitHub App installation.
      # See <https://github.com/actions/create-github-app-token>.
      # Default: "${{ github.repository_owner }}"
      build-secret-github-app-owner: ""
```

<!-- end usage -->
<!-- start secrets -->

## Secrets

| **Secret**                                   | **Description**                                                                                                                                                  | **Required** |
| -------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------ |
| **<code>oci-registry-password</code>**       | Password or GitHub token (`packages:read` and `packages:write` scopes) used to log against the OCI registry. See <https://github.com/docker/login-action#usage>. | **true**     |
| **<code>build-secrets</code>**               | List of secrets to expose to the build. See <https://docs.docker.com/build/ci/github-actions/secrets/>.                                                          | **false**    |
| **<code>build-secret-github-app-key</code>** | GitHub App private key to generate GitHub token to be passed as build secret env. See <https://github.com/actions/create-github-app-token>.                      | **false**    |

<!-- end secrets -->
<!-- markdownlint-disable MD013 -->
<!-- start inputs -->

## Inputs

| **Input**                                          | **Description**                                                                                                                                                                                                                                                                                                                                                                     | **Default**                                 | **Required** | **Type**    |
| -------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------- | ------------ | ----------- |
| **<code>runs-on</code>**                           | Json array of runner(s) to use. See <https://docs.github.com/en/actions/using-jobs/choosing-the-runner-for-a-job>                                                                                                                                                                                                                                                                   | <code>["ubuntu-latest"]</code>              | **false**    | **string**  |
| **<code>oci-registry</code>**                      | OCI registry where to pull and push images                                                                                                                                                                                                                                                                                                                                          | <code>ghcr.io</code>                        | **false**    | **string**  |
| **<code>oci-registry-username</code>**             | Username used to log against the OCI registry. See <https://github.com/docker/login-action#usage>                                                                                                                                                                                                                                                                                   | <code>${{ github.repository_owner }}</code> | **false**    | **string**  |
| **<code>images</code>**                            | Images to build parameters. Json array of objects. Example: [{ "name": "application", "context": ".", "dockerfile": "./docker/application/Dockerfile", "target": "prod", "build-args": { "APP_PATH": "./application/", "PROD_MODE": "true" }, "secret-envs": { "GH_TOKEN": "GITHUB_TOKEN" }, "platforms": ["linux/amd64", { "name": "darwin/amd64", "runs-on": "macos-latest" }] }] |                                             | **true**     | **string**  |
| **<code>lfs</code>**                               | Enable Git LFS. See <https://github.com/actions/checkout?tab=readme-ov-file#usage>.                                                                                                                                                                                                                                                                                                 | <code>true</code>                           | **false**    | **boolean** |
| **<code>build-secret-github-app-token-env</code>** | Environment variable name(s) to pass GitHub token generated by GitHub App. Can be a multiline string list. This is useful to pass a generated token to the build, as it is not possible to share generated secrets between jobs. Needs input `build-secret-github-app-id` and secret `build-secret-github-app-key`.                                                                 | <code>GITHUB_APP_TOKEN</code>               | **false**    | **string**  |
| **<code>build-secret-github-app-id</code>**        | GitHub App ID to generate GitHub token to be passed as build secret env. See <https://github.com/actions/create-github-app-token>.                                                                                                                                                                                                                                                  |                                             | **false**    | **string**  |
| **<code>build-secret-github-app-owner</code>**     | The owner of the GitHub App installation. See <https://github.com/actions/create-github-app-token>.                                                                                                                                                                                                                                                                                 | <code>${{ github.repository_owner }}</code> | **false**    | **string**  |

<!-- end inputs -->
<!-- markdownlint-enable MD013 -->

### Images entry parameters

| **Parameter**                | **Description**                                                                                                                                                                                                                                            | **Default**             | **Required** |
| ---------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------- | ------------ |
| **<code>name</code>**        | Image name. Must be unique. It is used as `image` in [Docker build-image action](../../actions/docker/build-image/README.md)                                                                                                                               |                         | **true**     |
| **<code>repository</code>**  | Repository name. See [Docker build-image action](../../actions/docker/build-image/README.md)                                                                                                                                                               |                         | **false**    |
| **<code>context</code>**     | Build context. See [Docker build-image action](../../actions/docker/build-image/README.md)                                                                                                                                                                 | <code>.</code>          | **false**    |
| **<code>dockerfile</code>**  | Location of Dockerfile. See [Docker build-image action](../../actions/docker/build-image/README.md)                                                                                                                                                        | <code>Dockerfile</code> | **false**    |
| **<code>target</code>**      | Sets the target stage to build. See [Docker build-image action](../../actions/docker/build-image/README.md)                                                                                                                                                |                         | **true**     |
| **<code>build-args</code>**  | List of build-time variables. See [Docker build-image action](../../actions/docker/build-image/README.md)                                                                                                                                                  |                         | **false**    |
| **<code>secret-envs</code>** | List of secret environment variables to expose to the build. See [Docker build-image action](../../actions/docker/build-image/README.md)                                                                                                                   |                         | **false**    |
| **<code>platforms</code>**   | List of platforms to build for. It is used as `platform` in [Docker build-image action](../../actions/docker/build-image/README.md). Can be a string (Example: `linux/amd64`) or an object (Example: `{"name": "darwin/amd64","runs-on": "macos-latest"}`) |                         | **true**     |

#### Platforms entry parameters

| **Parameter**            | **Description**                                                                                                   | **Default** | **Required** |
| ------------------------ | ----------------------------------------------------------------------------------------------------------------- | ----------- | ------------ |
| **<code>name</code>**    | Platform name. Example: `linux/amd64`                                                                             |             | **true**     |
| **<code>runs-on</code>** | Json array of runner(s) to use. See <https://docs.github.com/en/actions/using-jobs/choosing-the-runner-for-a-job> |             | **false**    |

##### Default `runs-on` strategy

If a platform entry omits the <code>runs-on</code> field, the following default strategy applies:

- When the main <code>docker-build-images</code> job uses a standard hosted runner, that runner is automatically matched to each platform.
- If the main <code>docker-build-images</code> job uses a custom or self-hosted runner, all platforms use the same runner.

<!-- start outputs -->

## Outputs

| **Output**                    | **Description**                                                                  |
| ----------------------------- | -------------------------------------------------------------------------------- |
| **<code>built-images</code>** | Built images data. Example: <code>{ "application": { build-image-data } }</code> |

### Built image data

| **Parameter**                | **Description**                    | **Example**                                                                                                                                                                                                                                       |
| ---------------------------- | ---------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **<code>name</code>**        | Image name                         | `application`                                                                                                                                                                                                                                     |
| **<code>registry</code>**    | Registry where the image is stored | `ghcr.io`                                                                                                                                                                                                                                         |
| **<code>repository</code>**  | Repository name                    | `my-org/my-repo/application`                                                                                                                                                                                                                      |
| **<code>tags</code>**        | List of tags                       | `["pr-63-5222075","pr-63"]`                                                                                                                                                                                                                       |
| **<code>images</code>**      | List of images                     | `["ghcr.io/my-org/my-repo/application:pr-63-5222075@sha256:d31aa93410434ac9dcfc9179cac2cb1fd4d7c27f11527addc40299c7c675f49d","ghcr.io/my-org/my-repo/application:pr-63@sha256:d31aa93410434ac9dcfc9179cac2cb1fd4d7c27f11527addc40299c7c675f49d"]` |
| **<code>digest</code>**      |                                    | `sha256:d31aa93410434ac9dcfc9179cac2cb1fd4d7c27f11527addc40299c7c675f49d`                                                                                                                                                                         |
| **<code>annotations</code>** | List of annotations                | `{"org.opencontainers.image.created": "2021-09-30T14:00:00Z","org.opencontainers.image.description": "Application image"}`                                                                                                                        |

<!-- end outputs -->
<!-- start [.github/ghadocs/examples/] -->
<!-- end [.github/ghadocs/examples/] -->
